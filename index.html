import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';

const HadithAPIComponent = () => {
  const [editions, setEditions] = useState([]);
  const [selectedEdition, setSelectedEdition] = useState('');
  const [hadithNumber, setHadithNumber] = useState('');
  const [result, setResult] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  useEffect(() => {
    fetchEditions();
  }, []);

  const fetchWithFallback = async (url, fallbackUrl) => {
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return await response.json();
    } catch (error) {
      console.warn(`Error fetching from ${url}, trying fallback...`);
      const fallbackResponse = await fetch(fallbackUrl);
      if (!fallbackResponse.ok) {
        throw new Error(`Fallback HTTP error! status: ${fallbackResponse.status}`);
      }
      return await fallbackResponse.json();
    }
  };

  const fetchEditions = async () => {
    try {
      const data = await fetchWithFallback(
        'https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions.min.json',
        'https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions.json'
      );
      setEditions(Object.keys(data));
      setError(null);
    } catch (error) {
      console.error('Error fetching editions:', error);
      setError(`Error fetching editions: ${error.message}. Please check your internet connection and try again.`);
    }
  };

  const fetchHadith = async () => {
    if (!selectedEdition || !hadithNumber) {
      setError('Please select an edition and enter a hadith number.');
      return;
    }

    setLoading(true);
    setError(null);
    try {
      const data = await fetchWithFallback(
        `https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions/${selectedEdition}/${hadithNumber}.min.json`,
        `https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions/${selectedEdition}/${hadithNumber}.json`
      );
      setResult(JSON.stringify(data, null, 2));
    } catch (error) {
      console.error('Error fetching hadith:', error);
      setError(`Error fetching hadith: ${error.message}. Please try again.`);
      setResult('');
    }
    setLoading(false);
  };

  return (
    <div className="container mx-auto p-4">
      <h1 className="text-3xl font-bold text-center mb-6">Hadith API Dashboard</h1>

      {error && (
        <Alert variant="destructive" className="mb-6">
          <AlertTitle>Error</AlertTitle>
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      <Card className="mb-6">
        <CardHeader>
          <h2 className="text-2xl font-semibold">Features</h2>
        </CardHeader>
        <CardContent>
          <ul className="list-disc pl-5">
            <li>Free & Blazing Fast response</li>
            <li>No Rate limits</li>
            <li>Multiple Languages</li>
            <li>Multiple Grades</li>
          </ul>
        </CardContent>
      </Card>

      <Card className="mb-6">
        <CardHeader>
          <h2 className="text-2xl font-semibold">Fetch Hadith</h2>
        </CardHeader>
        <CardContent>
          <div className="flex flex-col space-y-4">
            <Select onValueChange={setSelectedEdition}>
              <SelectTrigger>
                <SelectValue placeholder="Select Edition" />
              </SelectTrigger>
              <SelectContent>
                {editions.map((edition) => (
                  <SelectItem key={edition} value={edition}>
                    {edition}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <Input
              type="number"
              placeholder="Enter Hadith Number"
              value={hadithNumber}
              onChange={(e) => setHadithNumber(e.target.value)}
            />
            <Button onClick={fetchHadith} disabled={loading}>
              {loading ? 'Loading...' : 'Fetch Hadith'}
            </Button>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <h2 className="text-2xl font-semibold">Result</h2>
        </CardHeader>
        <CardContent>
          <pre className="bg-gray-100 p-4 rounded-md overflow-x-auto">
            {result || 'No result yet. Fetch a hadith to see the result.'}
          </pre>
        </CardContent>
      </Card>
    </div>
  );
};

export default HadithAPIComponent;
